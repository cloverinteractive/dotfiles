#!/usr/bin/env bash

# Where we're at right now
START_WD=$(pwd -P)

# What dotfiles branch we want to install
BRANCH_NAME=$1

# All the colors we're using for notifications
SWITCH="\033["
RED="${SWITCH}0;31m"
GREEN="${SWITCH}0;32m"
YELLOW="${SWITCH}1;33m"
NORMAL="${SWITCH}0m"

set -e
echo ''

FILES=(
  "bash"
  "git"
  "local"
  "postgres"
  "rubygems"
  "tmux"
  "vim"
  "X"
)

# Print red
error () {
  printf "\r${RED}$1${NORMAL}\n"
  exit
}

# Print green
success () {
  printf "\r${GREEN}$1${NORMAL}\n"
}

# Print yellow
info () {
  printf "\r${YELLOW}$1${NORMAL}\n"
}

fetch_dotfiles () {
  info "Fetching dotfiles..."

  # Figure out the branch we're working on
  if ! [ $BRANCH_NAME ]; then BRANCH_NAME=master; fi

  git clone -b $BRANCH_NAME https://github.com/cloverinteractive/dotfiles.git ~/.dotfiles
  cd ~/.dotfiles

  # Setup submodules to get Vundle working
  git submodule init
  git submodule update

  info "Installing ruby..."
  rbenv install

  if [[ $? == 0 ]]; then
    success "ruby installed"
  fi
}

info "Fetching vim-plug"
curl -fLo ./vim/.vim/autoload/plug.vim --create-dirs \
      https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim

info "Fetching fnm"
curl -fsSL https://fnm.vercel.app/install | bash

for file in "${FILES[@]}"; do
  # Rename if original exists
  [ -f "$HOME/$file" ] && mv "$HOME/$file" "$HOME/${file}.orig"

  info "Linking $file"
  stow "$file"
done

source $HOME/.bash/paths
eval "`fnm env`"

info "Installing Node LTS and yarn"
fnm install --lts && npm install -g yarn

info "Installing vim plugins"
vim +PlugInstall +qa

success "Thanks for installing, please report any issues to https://github.com/cloverinteractive/dotfiles/issues"
info "Run source ~/.bash_profile to load your environment"
